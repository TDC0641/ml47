<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ML47（マラソンログ47）</title>

<style>
  :root { --green:#2ecc71; --border:#e5e7eb; --muted:#6b7280; }
  html,body{ background:#fff; margin:0; font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; }

  .header{ padding:10px 12px 0; font-weight:800; font-size:1.25rem; }
  .tabs{ display:flex; border-bottom:1px solid var(--border); position:sticky; top:0; background:#fff; z-index:5 }
  .tab-btn{ flex:1; padding:12px 8px; cursor:pointer; font-weight:600; text-align:center; border:none; background:#fff; }
  .tab-btn.active{ border-bottom:3px solid #111; }

  .tab-content{ display:none; padding:12px; }
  .tab-content.active{ display:block; }

  #mapWrap{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px; min-height:60vh;
            display:flex; align-items:center; justify-content:center; }
  svg{ width:100%; height:auto; display:block; }

  .hoverable{ cursor:pointer; }
  .logged{ fill:var(--green)!important; fill-opacity:.7!important; }

  .addbar{ display:grid; grid-template-columns:120px 120px 1fr 120px; gap:8px; margin:8px 0; }
  .addbar button{ font-weight:600; }

  .toolbar{ display:flex; align-items:center; gap:8px; margin:12px 0; }
  .spacer{ flex:1 }

  table{ width:100%; border-collapse:collapse; border:1px solid var(--border); }
  th,td{ padding:8px; border-top:1px solid var(--border); font-size:.9rem; }
  th{ background:#f9fafb; }

  .muted{ color:var(--muted); }
</style>
</head>

<body>
<div class="header">ML47（マラソンログ47）</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="map">地図</button>
  <button class="tab-btn" data-tab="logs">ログ</button>
</div>

<section id="tab-map" class="tab-content active">
  <div id="mapWrap">地図を読み込み中…</div>
  <p class="muted">県をタップしてログを追加できます</p>
</section>

<section id="tab-logs" class="tab-content">
  <div class="addbar">
    <select id="addDist">
      <option>フル</option><option>ハーフ</option><option>30K</option>
      <option>20K</option><option>10K</option><option>5K</option>
    </select>
    <select id="addPref"></select>
    <input id="addRace" placeholder="大会名">
    <button id="addBtn">追加</button>
  </div>

  <div class="toolbar">
    <label>距離:</label>
    <select id="distanceFilter">
      <option value="ALL">全て</option>
      <option>フル</option><option>ハーフ</option>
      <option>30K</option><option>20K</option>
      <option>10K</option><option>5K</option>
    </select>
    <div class="spacer"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>県</th>
        <th>日付</th>
        <th>距離</th>
        <th>大会</th>
      </tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>
</section>

<script>
(() => {
  const PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県",
               "埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県",
               "岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県",
               "鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県",
               "福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];

  const LS_KEY="ml47.logs";
  const logs=JSON.parse(localStorage.getItem(LS_KEY)||"[]");

  const addPref=document.getElementById("addPref");
  addPref.innerHTML=PREFS.map(p=>`<option>${p}</option>`).join("");

  function save(){ localStorage.setItem(LS_KEY,JSON.stringify(logs)); }

  document.getElementById("addBtn").onclick=()=>{
    logs.push({
      pref:addPref.value,
      dist:document.getElementById("addDist").value,
      race:document.getElementById("addRace").value,
      date:new Date().toISOString().slice(0,10)
    });
    save(); renderTable(); paintMap();
  };

  function renderTable(){
    const f=document.getElementById("distanceFilter").value;
    const body=document.getElementById("logBody");
    body.innerHTML="";
    logs.filter(l=>f==="ALL"||l.dist===f).forEach(l=>{
      body.insertAdjacentHTML("beforeend",
        `<tr><td>${l.pref}</td><td>${l.date}</td><td>${l.dist}</td><td>${l.race}</td></tr>`);
    });
  }

  document.getElementById("distanceFilter").onchange=renderTable;

  // tabs
  document.querySelectorAll(".tab-btn").forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      document.getElementById("tab-"+b.dataset.tab).classList.add("active");
      if(b.dataset.tab==="logs") renderTable();
    };
  });

  // map
  fetch("https://raw.githubusercontent.com/geolonia/japanese-prefectures/master/map-full.svg")
    .then(r=>r.text()).then(t=>{
      document.getElementById("mapWrap").innerHTML=t;
      paintMap();
      document.querySelectorAll("g.prefecture").forEach(g=>{
        const name=g.querySelector("title")?.textContent;
        g.onclick=()=>alert(name);
      });
    });

  function paintMap(){
    const used=new Set(logs.map(l=>l.pref));
    document.querySelectorAll("g.prefecture").forEach(g=>{
      const name=g.querySelector("title")?.textContent;
      g.classList.toggle("logged", used.has(name));
    });
  }

  renderTable();
})();
</script>
</body>
</html>
