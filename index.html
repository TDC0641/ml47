<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ML47 テスト（最小）</title>
<style>
  :root{ --green:#2ecc71; --border:#e5e7eb; }
  html,body{ margin:0; background:#fff; font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif; }
  #mapWrap{ min-height:70vh; display:flex; align-items:center; justify-content:center; padding:12px; border:1px solid var(--border); margin:12px; border-radius:12px; background:#fff; }
  svg{ width:100%; height:auto; display:block; background:#fff; }
  .hoverable{ cursor:pointer; }
</style>
</head>
<body>
  <div id="mapWrap">地図を読み込み中…</div>

<script>
(async () => {
  const wrap = document.getElementById('mapWrap');
  try {
    // 同階層の map.svg を取得（キャッシュ回避）
    const res = await fetch('./map.svg?v=' + Date.now(), { cache:'no-store' });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const svgText = await res.text();

    // SVGとして厳密にパースし、text/tspanを除去
    const doc = new DOMParser().parseFromString(svgText, 'image/svg+xml');
    doc.querySelectorAll('text,tspan').forEach(n=>n.remove());

    let svg = doc.querySelector('svg');
    if (!svg) throw new Error('SVG root not found');
    svg = document.importNode(svg, true);
    wrap.innerHTML = '';
    wrap.appendChild(svg);

    // ハイライト用レイヤー（最上面、クリックは素通し）
    let hi = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    hi.setAttribute('id','ml47-highlight');
    hi.style.pointerEvents = 'none';
    svg.appendChild(hi);

    // クリック対象のタグ（namespace差異は localName で吸収）
    const TAGS = new Set(['path','polygon','polyline','rect','circle','ellipse','use']);
    const drawables = Array.from(svg.querySelectorAll('*')).filter(el=>TAGS.has(el.localName));

    // 県クリック：alert + ハイライトクローンを重ねる
    drawables.forEach(el=>{
      el.style.pointerEvents = 'all';
      el.classList.add('hoverable');
      el.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const node = el.closest('g') ?? el;
        const pref =
          node.getAttribute('data-pref') ||
          node.id?.replace(/^pref-/,'') ||
          node.querySelector('title')?.textContent?.trim() ||
          '（名称不明）';
        alert(`県: ${pref} にログ追加`);

        // 既存ハイライトをクリア
        while (hi.firstChild) hi.removeChild(hi.firstChild);

        // クローン対象を収集（gなら内部の描画要素、単体ならそれ自身）
        const targets = TAGS.has(node.localName)
          ? [node]
          : Array.from(node.querySelectorAll('*')).filter(n=>TAGS.has(n.localName));

        // 可視化：半透明の塗り＋太い枠線（stroke-onlyの地図でも見える）
        targets.forEach(src=>{
          const copy = src.cloneNode(true);
          copy.removeAttribute('clip-path');
          copy.style.pointerEvents = 'none';
          copy.setAttribute('fill','#2ecc71');
          copy.setAttribute('fill-opacity','0.35');
          copy.setAttribute('stroke','#2ecc71');
          copy.setAttribute('stroke-width','4');       // 線主体でもハッキリ見える
          hi.appendChild(copy);
        });
      }, {passive:true});
    });
  } catch (e) {
    wrap.textContent = 'map.svgの読み込みに失敗: ' + e.message;
  }
})();
</script>
</body>
</html>
