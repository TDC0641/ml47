<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ML47 テスト（最小）</title>
<style>
  :root{ --green:#2ecc71; --border:#e5e7eb; }
  html,body{ margin:0; background:#fff; font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif; }
  #mapWrap{ min-height:70vh; display:flex; align-items:center; justify-content:center; padding:12px; border:1px solid var(--border); margin:12px; border-radius:12px; background:#fff; }
  svg{ width:100%; height:auto; display:block; background:#fff; }
  .hoverable{ cursor:pointer; }

  /* クリック後のハイライト（要素自身にも効くように .logged 単体も指定） */
  .logged,
  .logged path, .logged polygon, .logged rect, .logged circle, .logged ellipse, .logged use{
    fill:#2ecc71 !important;
    stroke:#2ecc71 !important;
    fill-opacity:.7 !important;
    stroke-width:2 !important;
  }
</style>
</head>
<body>
  <div id="mapWrap">地図を読み込み中…</div>

<script>
(async () => {
  const wrap = document.getElementById('mapWrap');
  try {
    const res = await fetch('./map.svg?v=' + Date.now(), { cache:'no-store' });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);

    const svgText = await res.text();

    // SVGとして厳密にパース
    const doc = new DOMParser().parseFromString(svgText, 'image/svg+xml');

    // text/tspan を安全に除去（prefix付きも localName で判定）
    Array.from(doc.getElementsByTagName('*')).forEach(n=>{
      if (n.localName === 'text' || n.localName === 'tspan') n.remove();
    });

    let svg = doc.querySelector('svg');
    if (!svg) throw new Error('SVG root not found');

    // このドキュメントに取り込んでから挿入
    svg = document.importNode(svg, true);
    wrap.innerHTML = '';
    wrap.appendChild(svg);

    // SVG内の末尾に最優先のスタイルも埋め込む（内部<style>より後ろ）
    if (!svg.querySelector('#ml47-style')) {
      const s = document.createElementNS('http://www.w3.org/2000/svg','style');
      s.id = 'ml47-style';
      s.textContent =
        '.logged, .logged path, .logged polygon, .logged rect, .logged circle, .logged ellipse, .logged use{' +
        'fill:#2ecc71 !important; stroke:#2ecc71 !important; fill-opacity:.7 !important; stroke-width:2 !important;}';
      svg.appendChild(s);
    }

    const drawables = 'path,polygon,polyline,rect,circle,ellipse,use';

    // 県クリック（alert＋緑化）
    svg.querySelectorAll(drawables).forEach(el=>{
      el.style.pointerEvents = 'all';
      el.classList.add('hoverable');
      el.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        const node = el.closest('g') ?? el;
        const pref =
          node.getAttribute('data-pref') ||
          node.id?.replace(/^pref-/,'') ||
          node.querySelector('title')?.textContent?.trim() ||
          '（名称不明）';
        alert(`県: ${pref} にログ追加`);

        // クラス付与
        node.classList.add('logged');

        // 自身が図形なら直接スタイル
        if (node.matches?.(drawables)) {
          node.style.setProperty('fill','#2ecc71','important');
          node.style.setProperty('stroke','#2ecc71','important');
          node.style.setProperty('fill-opacity','.7','important');
          node.style.setProperty('stroke-width','2','important');
        }
        // 子要素にも適用
        node.querySelectorAll(drawables).forEach(p=>{
          p.style.setProperty('fill','#2ecc71','important');
          p.style.setProperty('stroke','#2ecc71','important');
          p.style.setProperty('fill-opacity','.7','important');
          p.style.setProperty('stroke-width','2','important');
        });
      }, { passive:true });
    });
  } catch (e) {
    wrap.textContent = 'map.svgの読み込みに失敗: ' + e.message;
  }
})();
</script>
</body>
</html>
