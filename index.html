<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ML47 テスト（最小）</title>
<style>
  :root{ --green:#2ecc71; --border:#e5e7eb; }
  html,body{ margin:0; background:#fff; font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif; }
  #mapWrap{ min-height:70vh; display:flex; align-items:center; justify-content:center; padding:12px; border:1px solid var(--border); margin:12px; border-radius:12px; background:#fff; }
  svg{ width:100%; height:auto; display:block; background:#fff; }
  .hoverable{ cursor:pointer; }
  .logged{ fill:var(--green) !important; fill-opacity:.7 !important; }
</style>
</head>
<body>
  <div id="mapWrap"><div id="loading">地図を読み込み中…</div></div>

  <script>
  (async () => {
    const wrap = document.getElementById('mapWrap');
    try {
      // Cache回避パラメータ付きで読み込み
      const res = await fetch('map.svg?v=ml47v6', { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status+' '+res.statusText);

      // テキスト要素は除去してから挿入
      const raw = await res.text();
      wrap.innerHTML = raw.replace(/<(?:[^>]*:)?(?:text|tspan)[^>]*>[\s\S]*?<\/(?:[^>]*:)?(?:text|tspan)>/gi,'');
      const svg = wrap.querySelector('svg');
      if (!svg) throw new Error('SVG not found');

      // 念のための非表示スタイル
      const sty = document.createElementNS('http://www.w3.org/2000/svg','style');
      sty.textContent = 'text,tspan{display:none!important}';
      svg.insertBefore(sty, svg.firstChild);

      // 県クリック（alert ＋ 緑化）
      svg.querySelectorAll('path,polygon,polyline,rect,circle,ellipse').forEach(el=>{
        el.style.pointerEvents='all';
        el.classList.add('hoverable');
        el.addEventListener('click',(ev)=>{
          ev.stopPropagation();
          const g = el.closest('g');
          const pref =
            g?.getAttribute('data-pref') ||
            g?.querySelector('title')?.textContent?.trim() ||
            el.id || '（名称不明）';
          alert(`県: ${pref} にログ追加`);
          (g||el).classList.add('logged');
        }, {passive:true});
      });
    } catch (e) {
      const msg = document.getElementById('loading');
      if (msg) msg.textContent = 'map.svgの読み込みに失敗: ' + e.message;
    }
  })();
  </script>
</body>
</html>
